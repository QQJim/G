<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作業繳交詳情 - 607班級網站</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .submission-container {
            margin: 30px 0;
        }
        
        .submission-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .submission-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .submission-title {
            margin: 0;
            color: var(--primary-color);
        }
        
        .submission-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .submission-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .submission-status.completed {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .submission-status.pending {
            background-color: #fff8e1;
            color: #ff8f00;
        }
        
        .submission-status.late {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .submission-date {
            color: var(--light-text);
            font-size: 0.9rem;
        }
        
        .submission-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: var(--light-text);
            margin-bottom: 5px;
        }
        
        .info-value {
            font-weight: bold;
            color: var(--dark-text);
        }
        
        .submission-content {
            margin-bottom: 30px;
        }
        
        .submission-content h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .submission-content p {
            line-height: 1.6;
            white-space: pre-line;
        }
        
        .submission-files {
            margin-bottom: 30px;
        }
        
        .file-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .file-item:hover {
            background-color: #e0e0e0;
        }
        
        .file-icon {
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .file-name {
            font-size: 0.9rem;
        }
        
        .grading-section {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .grade-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .grade-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .grade-max {
            color: var(--light-text);
            font-size: 1rem;
        }
        
        .feedback-display {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .feedback-content {
            white-space: pre-line;
            line-height: 1.6;
        }
        
        .grading-form {
            margin-top: 20px;
        }
        
        .grade-input {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .grade-input input {
            width: 80px;
            text-align: center;
            font-size: 1.2rem;
            padding: 8px;
            margin-right: 10px;
        }
        
        .grade-input span {
            color: var(--light-text);
        }
        
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .back-btn i {
            margin-right: 5px;
        }
        
        .back-btn:hover {
            color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <h1>607班級網站</h1>
            </div>
            <nav id="main-nav">
                <ul>
                    <li><a href="../index.html">首頁</a></li>
                    <li><a href="announcements.html">最新公告</a></li>
                    <li><a href="homework.html" class="active">作業區</a></li>
                    <li><a href="photo-album.html">相簿</a></li>
                    <li><a href="message-board.html">留言板</a></li>
                    <li><a href="calendar.html">行事曆</a></li>
                    <li id="teacher-nav" style="display: none;"><a href="students-list.html">學生名單</a></li>
                    <li id="user-status"><a href="login.html">登入/註冊</a></li>
                </ul>
            </nav>
            <div class="mobile-menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
        </header>

        <main>
            <section class="page-header">
                <h2>作業繳交詳情</h2>
                <p>查看學生作業繳交內容與評分</p>
            </section>

            <section class="submission-container" id="submission-container">
                <!-- 作業繳交詳情將由JavaScript動態生成 -->
                <div class="skeleton-loader">
                    <div class="skeleton-line" style="width: 70%; height: 30px;"></div>
                    <div class="skeleton-line" style="width: 40%; height: 20px; margin-top: 10px;"></div>
                    <div class="skeleton-line" style="width: 100%; height: 15px; margin-top: 30px;"></div>
                    <div class="skeleton-line" style="width: 100%; height: 15px; margin-top: 10px;"></div>
                    <div class="skeleton-line" style="width: 100%; height: 15px; margin-top: 10px;"></div>
                    <div class="skeleton-line" style="width: 80%; height: 15px; margin-top: 10px;"></div>
                </div>
            </section>
        </main>

        <footer>
            <div class="footer-content">
                <div class="footer-section">
                    <h3>607班級網站</h3>
                    <p>我們的班級網站致力於提供最佳的線上學習體驗。</p>
                </div>
                <div class="footer-section">
                    <h3>快速連結</h3>
                    <ul>
                        <li><a href="../index.html">首頁</a></li>
                        <li><a href="announcements.html">最新公告</a></li>
                        <li><a href="homework.html">作業區</a></li>
                        <li><a href="photo-album.html">相簿</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>聯絡資訊</h3>
                    <p><i class="fas fa-envelope"></i> 607class@example.com</p>
                    <p><i class="fas fa-phone"></i> (02) 1234-5678</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 607班級網站. 版權所有.</p>
            </div>
        </footer>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    
    <!-- 自定義JavaScript -->
    <script src="../js/firebase-config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化導航欄
            initNavigation();
            
            // 獲取作業提交ID
            const urlParams = new URLSearchParams(window.location.search);
            const submissionId = urlParams.get('id');
            
            if (!submissionId) {
                // 如果沒有作業提交ID，顯示錯誤訊息
                document.getElementById('submission-container').innerHTML = `
                    <div class="error-message">
                        <h3>錯誤</h3>
                        <p>找不到指定的作業繳交</p>
                        <a href="homework.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回作業列表</a>
                    </div>
                `;
                return;
            }
            
            // 載入作業提交詳情
            loadSubmissionDetail(submissionId);
            
            // 載入作業提交詳情
            function loadSubmissionDetail(id) {
                db.collection('homework_submissions').doc(id).get()
                    .then(doc => {
                        if (doc.exists) {
                            const submission = doc.data();
                            submission.id = doc.id;
                            
                            // 獲取作業資訊
                            db.collection('homework').doc(submission.homeworkId).get()
                                .then(homeworkDoc => {
                                    if (homeworkDoc.exists) {
                                        const homework = homeworkDoc.data();
                                        homework.id = homeworkDoc.id;
                                        
                                        // 獲取學生資訊
                                        db.collection('users').doc(submission.studentId).get()
                                            .then(studentDoc => {
                                                if (studentDoc.exists) {
                                                    const student = studentDoc.data();
                                                    student.id = studentDoc.id;
                                                    
                                                    // 檢查當前用戶是否為老師或該學生
                                                    checkUserAccess(submission.studentId).then(hasAccess => {
                                                        if (hasAccess) {
                                                            renderSubmissionDetail(submission, homework, student);
                                                        } else {
                                                            // 沒有權限
                                                            document.getElementById('submission-container').innerHTML = `
                                                                <div class="error-message">
                                                                    <h3>權限不足</h3>
                                                                    <p>您沒有權限查看此作業繳交</p>
                                                                    <a href="homework.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回作業列表</a>
                                                                </div>
                                                            `;
                                                        }
                                                    });
                                                } else {
                                                    // 學生不存在
                                                    document.getElementById('submission-container').innerHTML = `
                                                        <div class="error-message">
                                                            <h3>錯誤</h3>
                                                            <p>找不到學生資訊</p>
                                                            <a href="homework.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回作業列表</a>
                                                        </div>
                                                    `;
                                                }
                                            })
                                            .catch(error => {
                                                console.error('獲取學生資訊錯誤:', error);
                                                document.getElementById('submission-container').innerHTML = `
                                                    <div class="error-message">
                                                        <h3>錯誤</h3>
                                                        <p>載入學生資訊時發生錯誤</p>
                                                        <a href="homework.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回作業列表</a>
                                                    </div>
                                                `;
                                            });
                                    } else {
                                        // 作業不存在
                                        document.getElementById('submission-container').innerHTML = `
                                            <div class="error-message">
                                                <h3>錯誤</h3>
                                                <p>找不到作業資訊</p>
                                                <a href="homework.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回作業列表</a>
                                            </div>
                                        `;
                                    }
                                })
                                .catch(error => {
                                    console.error('獲取作業資訊錯誤:', error);
                                    document.getElementById('submission-container').innerHTML = `
                                        <div class="error-message">
                                            <h3>錯誤</h3>
                                            <p>載入作業資訊時發生錯誤</p>
                                            <a href="homework.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回作業列表</a>
                                        </div>
                                    `;
                                });
                        } else {
                            // 作業提交不存在
                            document.getElementById('submission-container').innerHTML = `
                                <div class="error-message">
                                    <h3>錯誤</h3>
                                    <p>找不到指定的作業繳交</p>
                                    <a href="homework.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回作業列表</a>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        console.error('獲取作業提交詳情錯誤:', error);
                        document.getElementById('submission-container').innerHTML = `
                            <div class="error-message">
                                <h3>錯誤</h3>
                                <p>載入作業繳交詳情時發生錯誤</p>
                                <a href="homework.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回作業列表</a>
                            </div>
                        `;
                    });
            }
            
            // 渲染作業提交詳情
            function renderSubmissionDetail(submission, homework, student) {
                const container = document.getElementById('submission-container');
                
                // 確定作業狀態
                let statusClass = 'pending';
                let statusText = '待評分';
                
                if (submission.grade !== undefined && submission.grade !== null) {
                    statusClass = 'completed';
                    statusText = '已評分';
                }
                
                // 檢查是否逾期
                if (submission.isLate) {
                    statusClass = 'late';
                    statusText = '逾期繳交';
                }
                
                // 格式化日期
                const submittedDate = submission.submittedAt.toDate();
                const formattedSubmittedDate = formatDate(submittedDate);
                const dueDate = homework.dueDate.toDate();
                const formattedDueDate = formatDate(dueDate);
                
                // 建立HTML
                let html = `
                    <div class="submission-card">
                        <div class="submission-header">
                            <h2 class="submission-title">${homework.title}</h2>
                            <div class="submission-meta">
                                <span class="submission-status ${statusClass}">${statusText}</span>
                                <span class="submission-date">繳交時間: ${formattedSubmittedDate}</span>
                            </div>
                        </div>
                        
                        <div class="submission-info">
                            <div class="info-item">
                                <span class="info-label">學生</span>
                                <span class="info-value">${student.name || student.username}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">學號</span>
                                <span class="info-value">${student.studentNumber || '未設置'}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">截止日期</span>
                                <span class="info-value">${formattedDueDate}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">繳交狀態</span>
                                <span class="info-value">${submission.isLate ? '逾期繳交' : '準時繳交'}</span>
                            </div>
                        </div>
                        
                        <div class="submission-content">
                            <h3>作業內容</h3>
                            <p>${submission.content || '無文字內容'}</p>
                        </div>
                `;
                
                // 如果有附件，顯示附件列表
                if (submission.files && submission.files.length > 0) {
                    html += `
                        <div class="submission-files">
                            <h3>附件</h3>
                            <div class="file-list">
                    `;
                    
                    submission.files.forEach(file => {
                        // 根據檔案類型選擇圖標
                        let iconClass = 'fa-file';
                        const fileExt = file.name.split('.').pop().toLowerCase();
                        
                        if (['jpg', 'jpeg', 'png', 'gif'].includes(fileExt)) {
                            iconClass = 'fa-file-image';
                        } else if (['pdf'].includes(fileExt)) {
                            iconClass = 'fa-file-pdf';
                        } else if (['doc', 'docx'].includes(fileExt)) {
                            iconClass = 'fa-file-word';
                        } else if (['xls', 'xlsx'].includes(fileExt)) {
                            iconClass = 'fa-file-excel';
                        } else if (['ppt', 'pptx'].includes(fileExt)) {
                            iconClass = 'fa-file-powerpoint';
                        } else if (['zip', 'rar', '7z'].includes(fileExt)) {
                            iconClass = 'fa-file-archive';
                        }
                        
                        html += `
                            <a href="${file.url}" target="_blank" class="file-item">
                                <div class="file-icon">
                                    <i class="far ${iconClass}"></i>
                                </div>
                                <div class="file-name">${file.name}</div>
                            </a>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                
                // 如果已評分，顯示評分結果
                if (submission.grade !== undefined && submission.grade !== null) {
                    html += `
                        <div class="grading-section">
                            <h3>評分結果</h3>
                            <div class="grade-display">
                                <div class="grade-value">${submission.grade}</div>
                                <div class="grade-max">/ 100</div>
                            </div>
                    `;
                    
                    if (submission.feedback) {
                        html += `
                            <h3>教師回饋</h3>
                            <div class="feedback-display">
                                <div class="feedback-content">${submission.feedback}</div>
                            </div>
                        `;
                    }
                    
                    html += `</div>`;
                }
                
                // 檢查是否為老師
                checkUserRole().then(isTeacher => {
                    // 如果是老師且未評分，顯示評分表單
                    if (isTeacher && (submission.grade === undefined || submission.grade === null)) {
                        html += `
                            <div class="grading-section">
                                <h3>評分</h3>
                                <div class="grading-form">
                                    <div class="form-group">
                                        <label for="grade">分數</label>
                                        <div class="grade-input">
                                            <input type="number" id="grade" min="0" max="100" value="0">
                                            <span>/ 100</span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="feedback">回饋</label>
                                        <textarea id="feedback" rows="4" placeholder="輸入對學生的回饋..."></textarea>
                                    </div>
                                    <div class="action-buttons">
                                        <button class="btn" id="submit-grade-btn">提交評分</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 底部返回按鈕
                    html += `
                        <div class="action-buttons" style="margin-top: 30px;">
                            <a href="homework.html" class="back-btn">
                                <i class="fas fa-arrow-left"></i> 返回作業列表
                            </a>
                        </div>
                    `;
                    
                    html += `</div>`;
                    
                    container.innerHTML = html;
                    
                    // 如果是老師且未評分，綁定評分按鈕事件
                    if (isTeacher && (submission.grade === undefined || submission.grade === null)) {
                        document.getElementById('submit-grade-btn').addEventListener('click', () => {
                            submitGrade(submission.id);
                        });
                    }
                    
                    // 更新頁面標題
                    document.title = `${homework.title} - 作業繳交詳情 - 607班級網站`;
                });
            }
            
            // 提交評分
            function submitGrade(submissionId) {
                const grade = parseInt(document.getElementById('grade').value);
                const feedback = document.getElementById('feedback').value.trim();
                
                if (isNaN(grade) || grade < 0 || grade > 100) {
                    showAlert('請輸入有效的分數 (0-100)', 'danger');
                    return;
                }
                
                const submitBtn = document.getElementById('submit-grade-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = '提交中...';
                
                // 更新作業提交
                db.collection('homework_submissions').doc(submissionId).update({
                    grade: grade,
                    feedback: feedback,
                    gradedAt: timestamp(),
                    gradedBy: auth.currentUser.uid
                })
                .then(() => {
                    showAlert('評分已成功提交');
                    
                    // 重新載入作業提交詳情
                    setTimeout(() => {
                        loadSubmissionDetail(submissionId);
                    }, 1500);
                })
                .catch(error => {
                    console.error('提交評分錯誤:', error);
                    showAlert('提交評分時發生錯誤', 'danger');
                    submitBtn.disabled = false;
                    submitBtn.textContent = '提交評分';
                });
            }
            
            // 檢查用戶權限
            function checkUserAccess(studentId) {
                return new Promise((resolve) => {
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            // 檢查是否為該學生或老師
                            db.collection('users').doc(user.uid).get()
                                .then(doc => {
                                    if (doc.exists) {
                                        const userData = doc.data();
                                        
                                        // 如果是老師或該學生，允許訪問
                                        if (userData.role === 'teacher' || user.uid === studentId) {
                                            resolve(true);
                                        } else {
                                            resolve(false);
                                        }
                                    } else {
                                        resolve(false);
                                    }
                                })
                                .catch(() => {
                                    resolve(false);
                                });
                        } else {
                            resolve(false);
                        }
                    });
                });
            }
            
            // 檢查用戶角色
            function checkUserRole() {
                return new Promise((resolve) => {
                    auth.onAuthStateChanged(user => {
                        if (user) {
                            db.collection('users').doc(user.uid).get()
                                .then(doc => {
                                    if (doc.exists) {
                                        const userData = doc.data();
                                        resolve(userData.role === 'teacher');
                                    } else {
                                        resolve(false);
                                    }
                                })
                                .catch(() => {
                                    resolve(false);
                                });
                        } else {
                            resolve(false);
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>
